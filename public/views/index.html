<!DOCTYPE html>
<html lang="ja">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../stylesheets/style.css" />

    <title>Todoアプリ</title>
  </head>

  <body>
    <!--
    <h1>Todo App</h1>
    -->

    <nav>
      <a href="#" data-toggle="modal" data-target="#createtaskModal"
        >Add task</a
      >
      <a href="#" id="alldelete-button">Delete all</a>
      <a href="#" id="allchecks-button">Select all</a>
      <a href="#" id="allunchecks-button">Deselect all</a>
      <a href="#" data-toggle="modal" data-target="#createcategoryModal"
        >category</a
      >
      <div class="animation start-home"></div>
    </nav>

    <!--+ボタンーーーーーーーーーーーーーーーーーーーーーーーー
    <a href="#"
      ><button
        type="button"
        class="btn btn-dark"
        style="margin-top: 10px; margin-bottom: 10px"
        data-toggle="modal"
        data-target="#createtaskModal"
      >
        +
      </button></a
    >
    ーーーーーーーーーーーーーーーーーーーーーーーーーーー+ボタン終了--

    ーーーーー--メニューボタンーーーーーーーーーーーーーーーーーーーーーーーー
    <td>
      <input id="menu1" type="checkbox" />
      <label for="menu1" class="back"></label>
      <nav class="menu">
        <ul>
          <li>
            <a href="#">
              <span>ボタン１ </span>
            </a>
          </li>
          <li>
            <a href="#">
              <span>ボタン２ </span>
            </a>
          </li>
        </ul>
        <label for="menu1">閉じる</label>
      </nav>
      <section>
        <label for="menu1" class="menu_btn"></label>
      </section>
    </td>
    ーーーーーーーーーーーーーーーーーーーーーーメニューボタン終了--

    ーーーーーー一括削除ーーーーーーーーーーーーーーーーーーーーーーーーー
    <a href="#">
      <span>
        <button
          class="btn btn-danger"
          style="margin-top: 10px; margin-bottom: 10px"
          id="alldelete-button"
        >
          一括削除
        </button>
      </span>
    </a>
    ーーーーーーーーーーーーーーーーーーーーーーーーーー一括削除終了--ーー

    ーーーーーーーーーーーーーーーーーー一括選択ーーーーーーーーーーーーーーー
    <a href="#">
      <span>
        <button
          class="btn btn-dark"
          style="margin-top: 10px; margin-bottom: 10px"
          id="allchecks-button"
        >
          全て選択
        </button>
      </span>
    </a>
    ーーーーーーーーーーーーーーーーーーーーーーーーー一括取選択終了ーーーーーー

    ーーーーーーーーーーーーーーーーー編集ボタンーーーーーーーーーーーー
    <a href="#"
      ><button
        type="button"
        class="btn btn-dark"
        style="margin-top: 10px; margin-bottom: 10px"
        data-toggle="modal"
        data-target="#updatecategoryModal"
      >
        編集
      </button></a
    >
     ーーーーーーーーーーーーーーーーーーーーーーーー編集ボタン-->

    <!--todo名、期限、アラートのテーブル-->
    <ul id="task-list"></ul>
    <!--todo名、期限、アラートのテーブル（終了）-->

    <!--ページトップに戻る-->
    <a href="" class="btn btn--circle btn--circle-c btn--shadow"
      ><i class="fas fa-arrow-up">🔝</i></a
    >
    <!--ページトップに戻る（終了）-->

    <!-- タスクの追加(+)を押した場合 -->
    <div
      class="modal fade"
      id="createtaskModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="createtaskLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document" id="create-form">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createtaskModalLabel">タスク登録</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <form>
                <label for="task">タスク</label>
                <input type="text" class="form-control" name="task" />
                <label
                  for="deadline"
                  style="margin-top: 10px; margin-bottom: 10px"
                  >期限</label
                >
                <input type="date" name="deadline" class="form-control" />
                <label style="margin-top: 10px; margin-bottom: 10px"
                  >カテゴリ</label
                >
                <select class="form-control" id="category" name="category">
                  <option value="1">勉強</option>
                  <option value="2">仕事</option>
                  <option value="3">家事</option>
                  <option value="4">生活</option>
                </select>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              キャンセル
            </button>
            <button type="button" class="btn btn-primary" id="create-task">
              登録
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- タスクの追加を押した場合(終了) -->

    <!-- カテゴリの追加を押した場合 -->
    <div
      class="modal fade"
      id="createcategoryModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="createcategoryLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document" id="create-form">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createtaskModalLabel">カテゴリ追加</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <form>
                <label for="task">カテゴリ名</label>
                <input type="text" class="form-control" name="task" />
                <label style="margin-top: 10px; margin-bottom: 10px"
                  >既存のカテゴリ</label
                >
                <select class="form-control" id="category" name="category">
                  <option value="1">勉強</option>
                  <option value="2">仕事</option>
                  <option value="3">家事</option>
                  <option value="4">生活</option>
                  <ul id="category-list"></ul>
                </select>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              キャンセル
            </button>
            <button type="button" class="btn btn-primary" id="create-category">
              登録
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- カテゴリの追加を押した場合(終了) -->

    <!--編集を押した場合 ーーーーーーーーーーーーーーーーーーーーーーーー
    <div
      class="modal fade"
      id="updatecategoryModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="updatecategoryModal"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document" id="create-form">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createtaskModalLabel">カテゴリ追加</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <form>
                <label for="task">タスク</label>
                <input type="text" class="form-control" name="task" />
                <label style="margin-top: 10px; margin-bottom: 10px"
                  >カテゴリ</label
                >
                <select class="form-control" id="category" name="category">
                  <option value="1">勉強</option>
                  <option value="2">仕事</option>
                  <option value="3">家事</option>
                  <option value="4">生活</option>
                </select>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              キャンセル
            </button>
            <button type="button" class="btn btn-primary" id="create-task">
              登録
            </button>
          </div>
        </div>
      </div>
    </div>
    ーーーーーーーーーーーーーーーーーーーーーーーーーーー 編集を押した場合(終了) -->

    <!-- 更新を押した場合 -->
    <div
      class="modal fade"
      id="update_taskModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="update_taskLabel"
      aria-hidden="true"
    >
      <div class="update-form" id="update-form" style="display: none">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="update_taskModalLabel">タスク更新</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <form>
                  <input type="hidden" name="id" />
                  <label for="task">タスク</label>
                  <input
                    type="text"
                    class="form-control"
                    name="task"
                    id="task"
                  />
                  <label
                    for="Inputdate"
                    style="margin-top: 10px; margin-bottom: 10px"
                    >期限</label
                  >
                  <input
                    type="date"
                    name="deadline"
                    id="deadline"
                    class="form-control"
                  />
                  <label style="margin-top: 10px; margin-bottom: 10px"
                    >カテゴリ</label
                  >
                  <select class="form-control" id="category" name="category">
                    <option value="1">勉強</option>
                    <option value="2">仕事</option>
                    <option value="3">家事</option>
                    <option value="4">生活</option>
                  </select>
                  <label
                    for="status"
                    style="margin-top: 10px; margin-bottom: 10px"
                    >ステータス</label
                  >
                  <select class="form-control" name="status" id="status">
                    <option value="1">進行中</option>
                    <option value="2">完了</option>
                  </select>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                キャンセル
              </button>
              <button type="button" class="btn btn-primary" id="update-task">
                登録
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 更新を押した場合(終了) -->

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>

    <script src="../javascripts/index.js"></script>

    <script>
      //タスク追加の登録ボタンを押下時
      $("#create-task").on("click", async function () {
        const requestData = {
          taskName: $("#create-form input[name=task]").val(),
          deadline: $("#create-form input[name=deadline]").val(),
          category: $("#create-form select[name=category]").val(),
        };

        const responese = await httpPost(
          "//" + window.location.host + "/api/tasks",
          requestData
        );
        window.location.reload();
      });

      //タスク一覧取得
      $(async function () {
        const response = await httpGet(
          "//" + window.location.host + "/api/tasks"
        );

        //リストの繰り返し表示(アロー関数)[menuバー、タスク名、期限、アラート]
        const list = response.map((item) => {
          //本日の年ー月ー日を変換
          const today = new Date();
          const today_year = today.getFullYear(); //今日の年
          const today_month = today.getMonth() + 1; //今日の月
          const today_day = today.getDate(); //今日の日

          //deadlineの年ー月ー日を変換
          const dead_year = Number(item.deadline.slice(0, 4)); //年
          const dead_month = Number(item.deadline.slice(5, 7)); //月
          const dead_day = Number(item.deadline.slice(8, 10)); //日

          //今日と〆切のずれ
          const year_until = Number(`${dead_year - today_year}`); //〆切までの年
          const month_until = Number(`${dead_month - today_month}`); //〆切までの月
          const day_until = Number(`${dead_day + 1 - today_day}`); //〆切までの日数

          var x = 30;

          //残り日数の計算
          const until_deadline = `${
            365 * year_until + x * month_until + day_until
          }`;
          //表示日が1日ずれるのを修正
          if (dead_day < 31) {
            dead_d = `${dead_day + 1}`;
          } else {
            dead_d = `${dead_day}`;
          }

          //期限までの日数を計算
          if (until_deadline > 0 && month_until == 0) {
            dead_until = "期限まで残り" + day_until + "日です";
          } else if (until_deadline > 0 && month_until > 0) {
            dead_until =
              "期限まで残り" + month_until + "ヶ月と" + day_until + "日です";
          } else {
            dead_until = "期限を過ぎています";
          }

          return `
            <table class="table table-striped" style="margin-top: 20px; margin-bottom: 10px">
              <tbody>
                <tr>
                  <td>
                    <input type="checkbox" class="checks" value="${item.id}"><br>
                  </td>
                  <th>
                      <div class="hidden_box">
                        <label for="label${item.id}"><div class="menu icon" ></div></label>
                        <input type="checkbox" id="label${item.id}"/>
                      <div class="hidden_show">
                       <!--非表示ここから-->
                        <a href="#">
                                    <span>
                                      <button class="btn btn-danger" id="delete-button" data-id=${item.id} data-delete=${item.task_name}>削除</button>
                                    </span>
                                  </a>

                                  <a href="#">
                                    <span>
                                      <button class="btn btn-primary" type="button" id="update-button" data-id=${item.id} data-toggle="modal" data-target="#update_taskModal">更新</button>
                                    </span>
                                  </a>
                        <!--ここまで-->
                        </div>
                      </div>
                    </th>
                    <td> <div class="col" style="margin-top: 40px; margin-bottom: 10px"><span>${item.task_name}</span></div></td>
                     <td> <div class="col" style="margin-top: 40px; margin-bottom: 10px"><span>${dead_year}年${dead_month}月${dead_d}日</span></div></td>
                    <td>
                      <div class="hidden_box_1">
                        <input type="checkbox" class="toggle" id="label" style="margin-top: 10px; margin-bottom: 10px"/>
                      <div class="hidden_show">
                       <!--非表示ここから-->
                       <div class="col text-danger" style="margin-top: 10px; margin-bottom: 10px">${dead_until}</div>
                       <!--ここまで-->
                      </div>
                      </div>
                    </td>


                    </tr>
              </tbody>
            </table>`;
        });
        $("ul#task-list").append(list);
      });

      //更新ボタン押下時
      $(document).on("click", "#update-button", async function () {
        $("#update-form").show();
        const id = $(this).data("id");
        const response = await httpGet(
          "//" + window.location.host + `/api/tasks/${id}`
        );
        //日付の変更
        const date = new Date(response[0].deadline);
        const year = date.getFullYear();
        const month = ("0" + (date.getMonth() + 1)).slice(-2);
        const day = ("0" + date.getDate()).slice(-2);
        const deadlineVal = `${year}-${month}-${day}`;

        $("#update-form input[name=id]").val(response[0].id);
        $("#update-form input[name=task]").val(response[0].task_name);
        $("#update-form input[name=deadline]").val(deadlineVal);
        $("#update-form input[name=category]").val(response[0].category_id);
        $("#update-form input[name=status]").val(response[0].task_status);
      });

      //保存ボタン押下時
      $("#update-task").on("click", async function () {
        const id = $("#update-form input[name=id]").val();

        const requestData = {
          taskName: $("#update-form input[name=task]").val(),
          deadline: $("#update-form input[name=deadline]").val(),
          category: $("#update-form select[name=category]").val(),
          status: $("#update-form select[name=status]").val(),
        };

        const response = await httpUpdate(
          "//" + window.location.host + `/api/tasks/${id}`,
          requestData
        );

        window.location.reload();
      });

      //削除ボタン押下時
      $(document).on("click", "#delete-button", async function () {
        const taskName = $(this).data("delete");
        if (confirm(`下記の内容を削除します。\n ${taskName}`)) {
          const id = $(this).data("id");

          const response = await httpDelete(
            "//" + window.location.host + `/api/tasks/${id}`
          );

          window.location.reload();
        }
      });

      //全て選択
      $("#allchecks-button").on("click", async function () {
        var allchecks = document.getElementsByClassName("checks");

        for (i = 0; i < allchecks.length; i++) {
          allchecks[i].checked = true;
        }
      });

      //全て選択解除
      $("#allunchecks-button").on("click", async function () {
        var allunchecks = document.getElementsByClassName("checks");

        for (i = 0; i < allunchecks.length; i++) {
          allunchecks[i].checked = false;
        }
      });

      //一括削除ボタン押下時
      $("#alldelete-button").on("click", async function () {
        var checks = document.getElementsByClassName("checks");
        var str = "";

        for (i = 0; i < checks.length; i++) {
          if (checks[i].checked === true) {
            str = checks[i].value + " ";

            const response = await httpDelete(
              "//" + window.location.host + `/api/tasks/${str}`
            );
          }
        }
        window.location.reload();
      });

      //カテゴリ追加の登録ボタンを押下時
      $("#create-category").on("click", async function () {
        const requestData = {
          categoryName: $("#create-form input[name=task]").val(),
        };

        const responese = await httpPost(
          "//" + window.location.host + "/api/category",
          requestData
        );
        window.location.reload();
      });

      //カテゴリ一覧取得
      $(async function () {
        const response = await httpGet(
          "//" + window.location.host + "/api/category"
        );
      });
    </script>
  </body>
</html>
